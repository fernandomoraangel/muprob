<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribuciones de Probabilidad en la Música</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.2.0/dist/abcjs-basic-min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            width: 100%;
            height: 300px;
            margin: 20px 0;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1e293b;
        }

        .distribution-section {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out;
        }

        .distribution-section:hover {
            transform: translateY(-5px);
        }

        h1,
        h2 {
            color: #0f172a;
        }

        h2 {
            border-bottom: 2px solid #38bdf8;
            padding-bottom: 8px;
            margin-bottom: 16px;
        }

        .formula {
            font-size: 1.1em;
            margin: 16px 0;
            padding: 12px;
            background-color: #e0f2fe;
            border-left: 4px solid #38bdf8;
            border-radius: 4px;
            overflow-x: auto;
        }

        button {
            background-color: #0ea5e9;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s ease;
            cursor: pointer;
            margin-top: 8px;
            /* Added margin for spacing */
        }

        button:hover {
            background-color: #0284c7;
        }

        button:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
        }

        input[type="number"],
        input[type="text"],
        select {
            border: 1px solid #cbd5e1;
            padding: 8px 12px;
            border-radius: 6px;
            margin-right: 8px;
            margin-bottom: 8px;
            width: auto;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            align-items: center;
            margin-bottom: 16px;
        }

        .info-box {
            background-color: #f1f5f9;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }

        #enableAudioButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background-color: #10b981;
            box-shadow: 0 4px 14px 0 rgba(0, 0, 0, 0.15);
        }

        #enableAudioButton:hover {
            background-color: #059669;
        }

        .status-message {
            font-style: italic;
            color: #475569;
            margin-top: 8px;
        }

        .markov-matrix-container {
            display: grid;
            grid-template-columns: repeat(4, auto);
            gap: 5px;
            align-items: center;
            justify-content: start;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .markov-matrix-container input {
            width: 50px;
            /* Increased from 50px */
            padding: 4px;
            text-align: center;
        }

        .markov-matrix-label {
            font-weight: bold;
            text-align: center;
        }

        .abc-display {
            /* Style for the sheet music container */
            margin-top: 16px;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background-color: #f8fafc;
            overflow-x: auto;
            /* For very long scores */
            min-height: 80px;
            /* Minimum height to avoid collapse */
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <header class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">Música Probabilística: Una Aventura Sonora</h1>
        <p class="text-lg md:text-xl text-slate-700 max-w-3xl mx-auto">
            Explora cómo las distribuciones de probabilidad pueden ser herramientas creativas para componer melodías y
            secuencias musicales.
            Ajusta los parámetros, genera música, ¡escucha los resultados y ve la partitura!
        </p>
    </header>

    <button id="enableAudioButton">Habilitar Audio</button>

    <main id="content" class="max-w-5xl mx-auto">

        <div class="distribution-section">
            <h2 class="text-2xl font-semibold">Introducción: Probabilidad y Música</h2>
            <p class="mb-4">
                La música, en su esencia, es una secuencia de eventos sonoros organizados en el tiempo. La teoría de la
                probabilidad nos ofrece un marco matemático para modelar la incertidumbre y la aleatoriedad. Al aplicar
                estos conceptos a la música, podemos explorar nuevas formas de composición, generando texturas, melodías
                y ritmos con un grado controlado de sorpresa y estructura.
            </p>
            <p>
                Desde simples elecciones al azar hasta complejos procesos estocásticos, las distribuciones de
                probabilidad permiten a los compositores delegar ciertas decisiones creativas a modelos matemáticos,
                resultando en obras que pueden ser tanto predecibles en su carácter general como impredecibles en sus
                detalles específicos. Esta presentación te guiará a través de varias distribuciones y cómo pueden
                inspirar la creación musical.
            </p>
            <div class="info-box">
                <p><strong>Nota:</strong> Para escuchar las melodías generadas, asegúrate de hacer clic en el botón
                    "Habilitar Audio" (puede aparecer en la esquina inferior derecha) y luego en los botones "Generar y
                    Reproducir Melodía" de cada sección.</p>
            </div>
        </div>

        <div id="uniform" class="distribution-section">
            <h2 class="text-2xl font-semibold">1. Distribución Uniforme</h2>
            <p class="mb-2">Asigna la misma probabilidad a cada resultado posible dentro de un rango continuo o
                discreto.</p>
            <p class="formula">Continua: $f(x) = \frac{1}{b-a}$ para $a \le x \le b$</p>
            <p class="text-sm text-gray-600">Donde:</p>
            <ul class="list-disc list-inside text-sm text-gray-600">
                <li>$f(x)$: Función de densidad de probabilidad</li>
                <li>$a$: Límite inferior del rango</li>
                <li>$b$: Límite superior del rango</li>
                <li>$b-a$: Ancho total del rango</li>
            </ul>
            <p class="formula">Discreta: $P(X=k) = \frac{1}{n}$ para $k \in \{k_1, k_2, ..., k_n\}$</p>
            <p class="text-sm text-gray-600">Donde:</p>
            <ul class="list-disc list-inside text-sm text-gray-600">
                <li>$P(X=k)$: Probabilidad de que la variable aleatoria $X$ tome el valor $k$</li>
                <li>$n$: Número total de posibles resultados</li>
                <li>$k_1, k_2, ..., k_n$: Los $n$ posibles valores que puede tomar $X$</li>
            </ul>
            <div class="info-box">
                <p><strong>Contexto Histórico:</strong> Es la distribución más fundamental, implícita en juegos de azar
                    antiguos (dados, monedas).</p>
                <p><strong>Compositores y Obras:</strong> Usada en música aleatoria simple. John Cage la exploró en
                    obras como "Music of Changes".</p>
                <p><strong>Aplicación Musical:</strong> Selección aleatoria de notas de una escala definida, duraciones
                    o cualquier parámetro musical.</p>
            </div>
            <div class="chart-container">
                <canvas id="uniformChart"></canvas>
            </div>
            <div class="controls-grid">
                <label>Mínimo MIDI:</label>
                <input type="number" id="uniformMinNote" value="60" min="0" max="127" onchange="updateUniformChart()">
                <label>Máximo MIDI:</label>
                <input type="number" id="uniformMaxNote" value="72" min="0" max="127" onchange="updateUniformChart()">
                <label>Número de Notas:</label>
                <input type="number" id="uniformNumNotes" value="8" min="1" max="16" onchange="updateUniformChart()">
                <button onclick="playUniformMelody()">Generar y Reproducir Melodía</button>
            </div>
            <div id="abcDisplayUniform" class="abc-display"></div>
            <p id="statusUniform" class="status-message"></p>
        </div>

        <div id="bernoulli" class="distribution-section">
            <h2 class="text-2xl font-semibold">2. Distribución de Bernoulli</h2>
            <p class="mb-2">Modela un experimento con dos posibles resultados: éxito (1) o fracaso (0).</p>
            <p class="formula">$P(X=k) = p^k (1-p)^{1-k}$ para $k \in \{0,1\}$</p>
            <p class="text-sm text-gray-600">Donde:</p>
            <ul class="list-disc list-inside text-sm text-gray-600">
                <li>$P(X=k)$: Probabilidad de obtener el resultado $k$</li>
                <li>$k$: Resultado del experimento (0 para fracaso, 1 para éxito)</li>
                <li>$p$: Probabilidad de éxito</li>
                <li>$1-p$: Probabilidad de fracaso</li>
            </ul>
            <div class="info-box">
                <p><strong>Contexto Histórico:</strong> Nombrada por Jacob Bernoulli (siglo XVII-XVIII).</p>
                <p><strong>Aplicación Musical:</strong> Decidir si una nota se toca o es un silencio; elegir entre dos
                    alturas, duraciones o articulaciones.</p>
            </div>
            <div class="chart-container">
                <canvas id="bernoulliChart"></canvas>
            </div>
            <div class="controls-grid">
                <label>Probabilidad de Éxito (p):</label>
                <input type="number" id="bernoulliP" value="0.5" min="0" max="1" step="0.01"
                    onchange="updateBernoulliChart()">
                <label>Número de Eventos:</label>
                <input type="number" id="bernoulliNumEvents" value="10" min="1" max="50"
                    onchange="updateBernoulliChart()">
                <label>Nota Éxito (MIDI):</label>
                <input type="number" id="bernoulliNoteSuccess" value="60" min="0" max="127"
                    onchange="updateBernoulliChart()">
                <label>Nota Fracaso (MIDI, dejar vacío para silencio):</label>
                <input type="number" id="bernoulliNoteFailure" value="" min="0" max="127"
                    onchange="updateBernoulliChart()">
                <button onclick="playBernoulliMelody()">Generar y Reproducir Melodía</button>
            </div>
            <div id="abcDisplayBernoulli" class="abc-display"></div>
            <p id="statusBernoulli" class="status-message"></p>
        </div>

        <div id="binomial" class="distribution-section">
            <h2 class="text-2xl font-semibold">3. Distribución Binomial</h2>
            <p class="mb-2">Describe el número de éxitos en $n$ ensayos de Bernoulli independientes.</p>
            <p class="formula">$P(X=k) = \binom{n}{k} p^k (1-p)^{n-k}$</p>
            <p class="text-sm text-gray-600">Donde:</p>
            <ul class="list-disc list-inside text-sm text-gray-600">
                <li>$P(X=k)$: Probabilidad de obtener exactamente $k$ éxitos</li>
                <li>$\binom{n}{k}$: Número de combinaciones de $n$ elementos tomados de $k$ en $k$</li>
                <li>$n$: Número total de ensayos o intentos</li>
                <li>$k$: Número de éxitos buscados</li>
                <li>$p$: Probabilidad de éxito en cada ensayo</li>
                <li>$1-p$: Probabilidad de fracaso en cada ensayo</li>
            </ul>
            <div class="info-box">
                <p><strong>Contexto Histórico:</strong> También desarrollada por Jacob Bernoulli.</p>
                <p><strong>Aplicación Musical:</strong> Número de notas acentuadas en una frase; densidad de notas en un
                    compás.</p>
            </div>
            <div class="chart-container">
                <canvas id="binomialChart"></canvas>
            </div>
            <div class="controls-grid">
                <label>Número de Ensayos (n):</label>
                <input type="number" id="binomialN" value="10" min="1" max="50" onchange="updateBinomialChart()">
                <label>Probabilidad de Éxito (p):</label>
                <input type="number" id="binomialP" value="0.5" min="0" max="1" step="0.01"
                    onchange="updateBinomialChart()">
                <label>Nota Base (MIDI):</label>
                <input type="number" id="binomialBaseNote" value="60" min="0" max="127"
                    onchange="updateBinomialChart()">
                <button onclick="playBinomialMelody()">Generar y Reproducir Melodía</button>
            </div>
            <div id="abcDisplayBinomial" class="abc-display"></div>
            <p id="statusBinomial" class="status-message"></p>
        </div>

        <div id="poisson" class="distribution-section">
            <h2 class="text-2xl font-semibold">4. Distribución de Poisson</h2>
            <p class="mb-2">Probabilidad de un número de eventos en un intervalo fijo de tiempo/espacio.</p>
            <p class="formula">$P(X=k) = \frac{\lambda^k e^{-\lambda}}{k!}$</p>
            <p class="text-sm text-gray-600">Donde:</p>
            <ul class="list-disc list-inside text-sm text-gray-600">
                <li>$P(X=k)$: Probabilidad de que ocurran exactamente $k$ eventos</li>
                <li>$\lambda$: Tasa media de ocurrencia de eventos</li>
                <li>$k$: Número de eventos observados</li>
                <li>$e$: Número de Euler (aproximadamente 2.71828)</li>
                <li>$k!$: Factorial de $k$</li>
            </ul>
            <div class="info-box">
                <p><strong>Contexto Histórico:</strong> Siméon Denis Poisson (siglo XIX).</p>
                <p><strong>Compositores y Obras:</strong> Iannis Xenakis ("Metastaseis", "Pithoprakta") para densidad de
                    eventos sonoros.</p>
                <p><strong>Aplicación Musical:</strong> Número de notas por compás; aparición de eventos sonoros.</p>
            </div>
            <div class="chart-container">
                <canvas id="poissonChart"></canvas>
            </div>
            <div class="controls-grid">
                <label>Tasa Media ($\lambda$):</label>
                <input type="number" id="poissonLambda" value="3" min="0" max="20" step="0.1"
                    onchange="updatePoissonChart()">
                <label>Número de Intervalos:</label>
                <input type="number" id="poissonNumIntervals" value="8" min="1" max="50"
                    onchange="updatePoissonChart()">
                <label>Nota Fija (MIDI):</label>
                <input type="number" id="poissonNote" value="60" min="0" max="127" onchange="updatePoissonChart()">
                <button onclick="playPoissonMelody()">Generar y Reproducir Melodía</button>
            </div>
            <div id="abcDisplayPoisson" class="abc-display"></div>
            <p id="statusPoisson" class="status-message"></p>
        </div>

        <div id="normal" class="distribution-section">
            <h2 class="text-2xl font-semibold">5. Distribución Normal (Gaussiana)</h2>
            <p class="mb-2">Distribución continua en forma de campana.</p>
            <p class="formula">$f(x | \mu, \sigma^2) = \frac{1}{\sqrt{2\pi\sigma^2}} e^{-\frac{(x-\mu)^2}{2\sigma^2}}$
            </p>
            <p class="text-sm text-gray-600">Donde:</p>
            <ul class="list-disc list-inside text-sm text-gray-600">
                <li>$f(x)$: Función de densidad de probabilidad</li>
                <li>$\mu$: Media de la distribución</li>
                <li>$\sigma$: Desviación estándar</li>
                <li>$\sigma^2$: Varianza</li>
                <li>$x$: Valor de la variable aleatoria</li>
                <li>$e$: Número de Euler (aproximadamente 2.71828)</li>
                <li>$\pi$: Número Pi (aproximadamente 3.14159)</li>
            </ul>
            <div class="info-box">
                <p><strong>Contexto Histórico:</strong> De Moivre, Laplace, Gauss (siglo XVIII-XIX).</p>
                <p><strong>Aplicación Musical:</strong> Alturas agrupadas alrededor de una nota central; dinámicas;
                    duraciones.</p>
            </div>
            <div class="chart-container">
                <canvas id="normalChart"></canvas>
            </div>
            <div class="controls-grid">
                <label>Media ($\mu$):</label>
                <input type="number" id="normalMean" value="60" min="0" max="127" onchange="updateNormalChart()">
                <label>Desv. Estándar ($\sigma$):</label>
                <input type="number" id="normalStdDev" value="5" min="0.1" max="20" step="0.1"
                    onchange="updateNormalChart()">
                <label>Número de Notas:</label>
                <input type="number" id="normalNumNotes" value="8" min="1" max="16" onchange="updateNormalChart()">
                <button onclick="playNormalMelody()">Generar y Reproducir Melodía</button>
            </div>
            <div id="abcDisplayNormal" class="abc-display"></div>
            <p id="statusNormal" class="status-message"></p>
        </div>

        <div id="exponential" class="distribution-section">
            <h2 class="text-2xl font-semibold">6. Distribución Exponencial</h2>
            <p class="mb-2">Tiempo entre eventos en un proceso de Poisson.</p>
            <p class="formula">$f(x; \lambda) = \lambda e^{-\lambda x}$ para $x \ge 0$</p>
            <p class="text-sm text-gray-600">Donde:</p>
            <ul class="list-disc list-inside text-sm text-gray-600">
                <li>$f(x)$: Función de densidad de probabilidad</li>
                <li>$\lambda$: Parámetro de tasa (inverso del tiempo medio entre eventos)</li>
                <li>$x$: Tiempo hasta el próximo evento</li>
                <li>$e$: Número de Euler (aproximadamente 2.71828)</li>
            </ul>
            <div class="info-box">
                <p><strong>Contexto Histórico:</strong> Relacionada con Poisson.</p>
                <p><strong>Aplicación Musical:</strong> Generar duraciones de notas o silencios.</p>
            </div>
            <div class="chart-container">
                <canvas id="exponentialChart"></canvas>
            </div>
            <div class="controls-grid">
                <label>Tasa ($\lambda$):</label>
                <input type="number" id="expoLambda" value="2.0" min="0" max="10" step="0.1"
                    onchange="updateExponentialChart()">
                <label>Nota Fija (MIDI):</label>
                <input type="number" id="expoNote" value="60" min="0" max="127" onchange="updateExponentialChart()">
                <label>Número de Duraciones:</label>
                <input type="number" id="expoNumDurations" value="12" min="1" max="50"
                    onchange="updateExponentialChart()">
                <button onclick="playExponentialMelody()">Generar y Reproducir Melodía</button>
            </div>
            <div id="abcDisplayExponential" class="abc-display"></div>
            <p id="statusExponential" class="status-message"></p>
        </div>

        <div id="markov" class="distribution-section">
            <h2 class="text-2xl font-semibold">7. Cadenas de Markov</h2>
            <p class="mb-2">Secuencia de eventos donde la probabilidad de cada evento depende del estado anterior.</p>
            <p class="formula">Matriz de Transición: $P = [p_{ij}]$, donde $p_{ij} = P(X_{t+1}=j | X_t=i)$</p>
            <p class="text-sm text-gray-600">Donde:</p>
            <ul class="list-disc list-inside text-sm text-gray-600">
                <li>$P$: Matriz de transición</li>
                <li>$p_{ij}$: Probabilidad de transición del estado $i$ al estado $j$</li>
                <li>$X_t$: Estado del sistema en el tiempo $t$</li>
                <li>$X_{t+1}$: Estado del sistema en el siguiente paso de tiempo</li>
            </ul>
            <div class="info-box">
                <p><strong>Contexto Histórico:</strong> Andrey Markov (principios s. XX).</p>
                <p><strong>Compositores y Obras:</strong> Hiller & Isaacson ("Illiac Suite"), Xenakis ("Analogique
                    A-B").</p>
                <p><strong>Aplicación Musical:</strong> Generar secuencias de notas con transiciones probabilísticas.
                </p>
            </div>
            <div class="chart-container">
                <canvas id="markovChart"></canvas>
            </div>
            <div class="controls-grid">
                <div class="mt-6">
                    <p class="mb-2 font-medium">Matriz de Transición (8 estados: C4, D4, E4, F4, G4, A4, B4, C5):</p>
                    <p class="text-sm mb-2">Filas: Actual, Columnas: Siguiente. Suma de fila = 1.</p>
                    <div class="markov-matrix-container" style="grid-template-columns: repeat(9, auto);">
                        <div class="markov-matrix-label"></div>
                        <div class="markov-matrix-label">C4</div>
                        <div class="markov-matrix-label">D4</div>
                        <div class="markov-matrix-label">E4</div>
                        <div class="markov-matrix-label">F4</div>
                        <div class="markov-matrix-label">G4</div>
                        <div class="markov-matrix-label">A4</div>
                        <div class="markov-matrix-label">B4</div>
                        <div class="markov-matrix-label">C5</div>

                        <div class="markov-matrix-label">C4 →</div>
                        <input type="number" id="m00" value="0.4" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m01" value="0.2" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m02" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m03" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m04" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m05" value="0.05" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m06" value="0.02" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m07" value="0.03" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">

                        <div class="markov-matrix-label">D4 →</div>
                        <input type="number" id="m10" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m11" value="0.3" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m12" value="0.2" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m13" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m14" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m15" value="0.08" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m16" value="0.05" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m17" value="0.02" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">

                        <div class="markov-matrix-label">E4 →</div>
                        <input type="number" id="m20" value="0.05" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m21" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m22" value="0.3" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m23" value="0.2" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m24" value="0.15" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m25" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m26" value="0.08" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m27" value="0.02" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">

                        <div class="markov-matrix-label">F4 →</div>
                        <input type="number" id="m30" value="0.02" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m31" value="0.05" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m32" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m33" value="0.3" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m34" value="0.2" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m35" value="0.15" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m36" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m37" value="0.02" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">

                        <div class="markov-matrix-label">G4 →</div>
                        <input type="number" id="m40" value="0.03" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m41" value="0.08" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m42" value="0.15" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m43" value="0.2" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m44" value="0.3" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m45" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m46" value="0.07" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m47" value="0.03" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">

                        <div class="markov-matrix-label">A4 →</div>
                        <input type="number" id="m50" value="0.04" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m51" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m52" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m53" value="0.15" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m54" value="0.2" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m55" value="0.3" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m56" value="0.07" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m57" value="0.04" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">

                        <div class="markov-matrix-label">B4 →</div>
                        <input type="number" id="m60" value="0.05" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m61" value="0.05" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m62" value="0.08" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m63" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m64" value="0.15" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m65" value="0.2" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m66" value="0.3" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m67" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">

                        <div class="markov-matrix-label">C5 →</div>
                        <input type="number" id="m70" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m71" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m72" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m73" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m74" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m75" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m76" value="0.1" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                        <input type="number" id="m77" value="0.3" min="0" max="1" step="0.01"
                            onchange="updateMarkovChart()">
                    </div>
                    <p class="text-xs text-slate-600 mb-4">Nota: El sistema normalizará filas si no suman 1.</p>
                    <label>Longitud Melodía: <input type="number" id="markovLength" value="20" class="w-20"></label>
                    <button onclick="playMarkovMelody()">Generar y Reproducir Melodía de Markov</button>
                </div>
            </div>
            <div id="abcDisplayMarkov" class="abc-display"></div>
            <p id="statusMarkov" class="status-message"></p>
        </div>
    </main>
    <footer class="text-center mt-12 py-8 border-t border-slate-300">
        <p class="text-slate-600">&copy; 2024-2025 Música Probabilística Interactiva. Inspirado por las matemáticas y el
            arte.</p>
    </footer>

    <script>
        let synth;
        let audioEnabled = false;
        const baseDuration = "8n"; // Corchea como duración base
        const L_DEFAULT_SECONDS = Tone.Time("8n").toSeconds(); // Segundos para L:1/8 en ABC

        document.getElementById('enableAudioButton').addEventListener('click', async () => {
            if (!audioEnabled) {
                await Tone.start();
                synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0.3, release: 0.5 },
                    volume: -12
                }).toDestination();
                audioEnabled = true;
                console.log("Audio Context iniciado y sintetizador listo.");
                document.getElementById('enableAudioButton').style.display = 'none';
            }
        });

        function setStatus(elementId, message, isError = false) {
            const el = document.getElementById(elementId);
            if (el) {
                el.textContent = message;
                el.style.color = isError ? 'red' : '#475569';
            }
        }

        function stopPreviousMelody() {
            if (synth) {
                Tone.Transport.stop();
                Tone.Transport.cancel();
                synth.releaseAll();
            }
        }

        // Uniform Distribution
        function updateUniformChart() {
            const minNote = parseInt(document.getElementById('uniformMinNote').value);
            const maxNote = parseInt(document.getElementById('uniformMaxNote').value);
            const numNotes = parseInt(document.getElementById('uniformNumNotes').value);
            const range = maxNote - minNote + 1;
            const probability = 1 / range;

            const labels = Array.from({ length: range }, (_, i) => minNote + i);
            const data = Array(range).fill(probability);

            renderChart('uniformChart', 'Distribución Uniforme', labels, data, 'Nota MIDI', 'Probabilidad');
        }

        async function playUniformMelody() {
            stopPreviousMelody();
            const statusElement = document.getElementById('statusUniform');
            const abcDisplayElement = document.getElementById('abcDisplayUniform');
            const minNote = parseInt(document.getElementById('uniformMinNote').value);
            const maxNote = parseInt(document.getElementById('uniformMaxNote').value);
            const numNotes = parseInt(document.getElementById('uniformNumNotes').value);

            if (Tone.context.state !== 'running') {
                statusElement.textContent = 'Por favor, habilita el audio primero.';
                return;
            }

            statusElement.textContent = 'Generando melodía...';
            abcDisplayElement.innerHTML = ''; // Clear previous score

            const melody = [];
            for (let i = 0; i < numNotes; i++) {
                const randomNote = Math.floor(Math.random() * (maxNote - minNote + 1)) + minNote;
                melody.push(randomNote);
            }

            const now = Tone.now();
            let startTime = now;

            const abcNotes = melody.map(midiNote => {
                // Convert MIDI to note name (simplified)
                const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
                const octave = Math.floor(midiNote / 12) - 1;
                const noteIndex = midiNote % 12;
                let noteName = noteNames[noteIndex];

                // Convert note name to ABC notation (simplified)
                let abcNote = noteName.replace("#", "^"); // Handle sharps
                if (octave < 4) {
                    abcNote = abcNote.toLowerCase().repeat(4 - octave);
                } else if (octave > 4) {
                    abcNote = abcNote.toUpperCase() + "'".repeat(octave - 4);
                }
                 // Add duration (e.g., 4 for quarter note) - assuming quarter notes for simplicity
                return abcNote + '4';
            }).join(' ');


            melody.forEach((midiNote) => {
                const freq = Tone.Midi(midiNote).toFrequency();
                synth.triggerAttackRelease(freq, baseDuration, startTime);
                startTime += Tone.Time(baseDuration).toSeconds();
            });

            statusElement.textContent = 'Reproduciendo...';

            // Render ABC notation
            const abcString = `X:1\nT:Melodía Generada (Uniforme)\nM:4/4\nL:1/8\nK:C\n${abcNotes}|]`;
             ABCJS.renderAbc("abcDisplayUniform", abcString);


            // Update status after playback
            Tone.Transport.scheduleOnce(() => {
                statusElement.textContent = 'Melodía generada y reproducida.';
            }, startTime);
        }

        // Bernoulli Distribution
        function updateBernoulliChart() {
            const p = parseFloat(document.getElementById('bernoulliP').value);
            const labels = ['Fracaso (0)', 'Éxito (1)'];
            const data = [1 - p, p];

            renderChart('bernoulliChart', 'Distribución de Bernoulli', labels, data, 'Resultado', 'Probabilidad');
        }

        async function playBernoulliMelody() {
            stopPreviousMelody();
            const statusElement = document.getElementById('statusBernoulli');
            const abcDisplayElement = document.getElementById('abcDisplayBernoulli');
            const p = parseFloat(document.getElementById('bernoulliP').value);
            const numEvents = parseInt(document.getElementById('bernoulliNumEvents').value);
            const noteSuccess = parseInt(document.getElementById('bernoulliNoteSuccess').value);
            const noteFailureInput = document.getElementById('bernoulliNoteFailure').value;
            const noteFailure = noteFailureInput === '' ? null : parseInt(noteFailureInput);


            if (Tone.context.state !== 'running') {
                statusElement.textContent = 'Por favor, habilita el audio primero.';
                return;
            }

            statusElement.textContent = 'Generando melodía...';
            abcDisplayElement.innerHTML = ''; // Clear previous score

            const melody = [];
            for (let i = 0; i < numEvents; i++) {
                const result = Math.random() < p ? 1 : 0;
                if (result === 1) {
                    melody.push(noteSuccess);
                } else {
                    melody.push(noteFailure); // null for silence
                }
            }

            const now = Tone.now();
            let startTime = now;

            const abcNotes = melody.map(midiNote => {
                if (midiNote === null) {
                    return 'z4'; // z for rest, 4 for quarter note
                }
                // Convert MIDI to note name (simplified)
                const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
                const octave = Math.floor(midiNote / 12) - 1;
                const noteIndex = midiNote % 12;
                let noteName = noteNames[noteIndex];

                // Convert note name to ABC notation (simplified)
                let abcNote = noteName.replace("#", "^"); // Handle sharps
                if (octave < 4) {
                    abcNote = abcNote.toLowerCase().repeat(4 - octave);
                } else if (octave > 4) {
                    abcNote = abcNote.toUpperCase() + "'".repeat(octave - 4);
                }
                 // Add duration (e.g., 4 for quarter note) - assuming quarter notes for simplicity
                return abcNote + '4';
            }).join(' ');


            melody.forEach((midiNote) => {
                if (midiNote !== null) {
                    const freq = Tone.Midi(midiNote).toFrequency();
                    synth.triggerAttackRelease(freq, baseDuration, startTime);
                }
                startTime += Tone.Time(baseDuration).toSeconds();
            });

            statusElement.textContent = 'Reproduciendo...';

            // Render ABC notation
            const abcString = `X:1\nT:Melodía Generada (Bernoulli)\nM:4/4\nL:1/8\nK:C\n${abcNotes}|]`;
             ABCJS.renderAbc("abcDisplayBernoulli", abcString);


            // Update status after playback
            Tone.Transport.scheduleOnce(() => {
                statusElement.textContent = 'Melodía generada y reproducida.';
            }, startTime);
        }

        // Binomial Distribution
        function binomialCoefficient(n, k) {
            if (k < 0 || k > n) {
                return 0;
            }
            if (k === 0 || k === n) {
                return 1;
            }
            if (k > n / 2) {
                k = n - k;
            }
            let res = 1;
            for (let i = 1; i <= k; ++i) {
                res = res * (n - i + 1) / i;
            }
            return res;
        }

        function binomialProbability(n, k, p) {
            return binomialCoefficient(n, k) * Math.pow(p, k) * Math.pow(1 - p, n - k);
        }

        function updateBinomialChart() {
            const n = parseInt(document.getElementById('binomialN').value);
            const p = parseFloat(document.getElementById('binomialP').value);

            const labels = Array.from({ length: n + 1 }, (_, i) => i);
            const data = labels.map(k => binomialProbability(n, k, p));

            renderChart('binomialChart', 'Distribución Binomial', labels, data, 'Número de Éxitos', 'Probabilidad');
        }

        async function playBinomialMelody() {
            stopPreviousMelody();
            const statusElement = document.getElementById('statusBinomial');
            const abcDisplayElement = document.getElementById('abcDisplayBinomial');
            const n = parseInt(document.getElementById('binomialN').value);
            const p = parseFloat(document.getElementById('binomialP').value);
            const baseNote = parseInt(document.getElementById('binomialBaseNote').value);

            if (Tone.context.state !== 'running') {
                statusElement.textContent = 'Por favor, habilita el audio primero.';
                return;
            }

            statusElement.textContent = 'Generando melodía...';
            abcDisplayElement.innerHTML = ''; // Clear previous score

            const melody = [];
            for (let i = 0; i < n; i++) {
                const result = Math.random() < p ? 1 : 0;
                // Simple mapping: 0 -> baseNote, 1 -> baseNote + interval (e.g., a fifth)
                melody.push(baseNote + (result * 7)); // Adding a fifth for success
            }

            const now = Tone.now();
            let startTime = now;

            const abcNotes = melody.map(midiNote => {
                // Convert MIDI to note name (simplified)
                const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
                const octave = Math.floor(midiNote / 12) - 1;
                const noteIndex = midiNote % 12;
                let noteName = noteNames[noteIndex];

                // Convert note name to ABC notation (simplified)
                let abcNote = noteName.replace("#", "^"); // Handle sharps
                if (octave < 4) {
                    abcNote = abcNote.toLowerCase().repeat(4 - octave);
                } else if (octave > 4) {
                    abcNote = abcNote.toUpperCase() + "'".repeat(octave - 4);
                }
                 // Add duration (e.g., 4 for quarter note) - assuming quarter notes for simplicity
                return abcNote + '4';
            }).join(' ');


            melody.forEach((midiNote) => {
                const freq = Tone.Midi(midiNote).toFrequency();
                synth.triggerAttackRelease(freq, baseDuration, startTime);
                startTime += Tone.Time(baseDuration).toSeconds();
            });

            statusElement.textContent = 'Reproduciendo...';

            // Render ABC notation
            const abcString = `X:1\nT:Melodía Generada (Binomial)\nM:4/4\nL:1/8\nK:C\n${abcNotes}|]`;
             ABCJS.renderAbc("abcDisplayBinomial", abcString);


            // Update status after playback
            Tone.Transport.scheduleOnce(() => {
                statusElement.textContent = 'Melodía generada y reproducida.';
            }, startTime);
        }

        // Poisson Distribution
        function poissonProbability(lambda, k) {
            return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
        }

        function factorial(n) {
            if (n < 0) return -1;
            if (n === 0) return 1;
            let result = 1;
            for (let i = n; i > 1; i--) {
                result *= i;
            }
            return result;
        }

        function updatePoissonChart() {
            const lambda = parseFloat(document.getElementById('poissonLambda').value);
            const maxK = Math.max(10, Math.ceil(lambda + 3 * Math.sqrt(lambda))); // Show enough values
            const labels = Array.from({ length: maxK + 1 }, (_, i) => i);
            const data = labels.map(k => poissonProbability(lambda, k));

            renderChart('poissonChart', 'Distribución de Poisson', labels, data, 'Número de Eventos (k)', 'Probabilidad');
        }

        async function playPoissonMelody() {
            stopPreviousMelody();
            const statusElement = document.getElementById('statusPoisson');
            const abcDisplayElement = document.getElementById('abcDisplayPoisson');
            const lambda = parseFloat(document.getElementById('poissonLambda').value);
            const numIntervals = parseInt(document.getElementById('poissonNumIntervals').value);
            const fixedNote = parseInt(document.getElementById('poissonNote').value);

            if (Tone.context.state !== 'running') {
                statusElement.textContent = 'Por favor, habilita el audio primero.';
                return;
            }

            statusElement.textContent = 'Generando melodía...';
            abcDisplayElement.innerHTML = ''; // Clear previous score

            const melody = [];
            for (let i = 0; i < numIntervals; i++) {
                // Generate number of events (notes) in this interval based on Poisson
                let numEventsInInterval = 0;
                let p = Math.exp(-lambda);
                let sum = p;
                let u = Math.random();

                if (u < sum) {
                    numEventsInInterval = 0;
                } else {
                    for (let k = 1; k <= 50; k++) { // Limit k to avoid infinite loop
                        p = (p * lambda) / k;
                        sum += p;
                        if (u < sum) {
                            numEventsInInterval = k;
                            break;
                        }
                    }
                }

                // Add the fixed note multiple times based on the number of events
                for (let j = 0; j < numEventsInInterval; j++) {
                    melody.push(fixedNote);
                }
                 // Add a rest if no events occurred in the interval
                if (numEventsInInterval === 0) {
                    melody.push(null);
                }
            }

            const now = Tone.now();
            let startTime = now;

            const abcNotes = melody.map(midiNote => {
                if (midiNote === null) {
                    return 'z4'; // z for rest, 4 for quarter note
                }
                // Convert MIDI to note name (simplified)
                const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
                const octave = Math.floor(midiNote / 12) - 1;
                const noteIndex = midiNote % 12;
                let noteName = noteNames[noteIndex];

                // Convert note name to ABC notation (simplified)
                let abcNote = noteName.replace("#", "^"); // Handle sharps
                if (octave < 4) {
                    abcNote = abcNote.toLowerCase().repeat(4 - octave);
                } else if (octave > 4) {
                    abcNote = abcNote.toUpperCase() + "'".repeat(octave - 4);
                }
                 // Add duration (e.g., 4 for quarter note) - assuming quarter notes for simplicity
                return abcNote + '4';
            }).join(' ');


            melody.forEach((midiNote) => {
                if (midiNote !== null) {
                    const freq = Tone.Midi(midiNote).toFrequency();
                    synth.triggerAttackRelease(freq, baseDuration, startTime);
                }
                startTime += Tone.Time(baseDuration).toSeconds();
            });

            statusElement.textContent = 'Reproduciendo...';

            // Render ABC notation
            const abcString = `X:1\nT:Melodía Generada (Poisson)\nM:4/4\nL:1/8\nK:C\n${abcNotes}|]`;
             ABCJS.renderAbc("abcDisplayPoisson", abcString);


            // Update status after playback
            Tone.Transport.scheduleOnce(() => {
                statusElement.textContent = 'Melodía generada y reproducida.';
            }, startTime);
        }

        // Normal Distribution
        function normalDensity(x, mean, stdDev) {
            const exponent = -Math.pow(x - mean, 2) / (2 * Math.pow(stdDev, 2));
            return (1 / (stdDev * Math.sqrt(2 * Math.PI))) * Math.exp(exponent);
        }

        function updateNormalChart() {
            const mean = parseFloat(document.getElementById('normalMean').value);
            const stdDev = parseFloat(document.getElementById('normalStdDev').value);

            const labels = Array.from({ length: 128 }, (_, i) => i); // MIDI notes 0-127
            const data = labels.map(midiNote => normalDensity(midiNote, mean, stdDev));

            renderChart('normalChart', 'Distribución Normal', labels, data, 'Nota MIDI', 'Densidad de Probabilidad');
        }

        async function playNormalMelody() {
            stopPreviousMelody();
            const statusElement = document.getElementById('statusNormal');
            const abcDisplayElement = document.getElementById('abcDisplayNormal');
            const mean = parseFloat(document.getElementById('normalMean').value);
            const stdDev = parseFloat(document.getElementById('normalStdDev').value);
            const numNotes = parseInt(document.getElementById('normalNumNotes').value);

            if (Tone.context.state !== 'running') {
                statusElement.textContent = 'Por favor, habilita el audio primero.';
                return;
            }

            statusElement.textContent = 'Generando melodía...';
            abcDisplayElement.innerHTML = ''; // Clear previous score

            const melody = [];
            for (let i = 0; i < numNotes; i++) {
                // Generate a random number from a normal distribution (Box-Muller transform)
                let u = 0, v = 0;
                while (u === 0) u = Math.random();
                while (v === 0) v = Math.random();
                const z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);

                // Scale and shift to desired mean and standard deviation
                let midiNote = Math.round(mean + stdDev * z);

                // Clamp to valid MIDI range (0-127)
                midiNote = Math.max(0, Math.min(127, midiNote));
                melody.push(midiNote);
            }

            const now = Tone.now();
            let startTime = now;

            const abcNotes = melody.map(midiNote => {
                // Convert MIDI to note name (simplified)
                const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
                const octave = Math.floor(midiNote / 12) - 1;
                const noteIndex = midiNote % 12;
                let noteName = noteNames[noteIndex];

                // Convert note name to ABC notation (simplified)
                let abcNote = noteName.replace("#", "^"); // Handle sharps
                if (octave < 4) {
                    abcNote = abcNote.toLowerCase().repeat(4 - octave);
                } else if (octave > 4) {
                    abcNote = abcNote.toUpperCase() + "'".repeat(octave - 4);
                }
                 // Add duration (e.g., 4 for quarter note) - assuming quarter notes for simplicity
                return abcNote + '4';
            }).join(' ');


            melody.forEach((midiNote) => {
                const freq = Tone.Midi(midiNote).toFrequency();
                synth.triggerAttackRelease(freq, baseDuration, startTime);
                startTime += Tone.Time(baseDuration).toSeconds();
            });

            statusElement.textContent = 'Reproduciendo...';

            // Render ABC notation
            const abcString = `X:1\nT:Melodía Generada (Normal)\nM:4/4\nL:1/8\nK:C\n${abcNotes}|]`;
             ABCJS.renderAbc("abcDisplayNormal", abcString);


            // Update status after playback
            Tone.Transport.scheduleOnce(() => {
                statusElement.textContent = 'Melodía generada y reproducida.';
            }, startTime);
        }

        // Exponential Distribution
        function exponentialDensity(x, lambda) {
            if (x < 0) return 0;
            return lambda * Math.exp(-lambda * x);
        }

        function updateExponentialChart() {
            const lambda = parseFloat(document.getElementById('expoLambda').value);
            const labels = Array.from({ length: 20 }, (_, i) => i * 0.5); // Time intervals
            const data = labels.map(x => exponentialDensity(x, lambda));

            renderChart('exponentialChart', 'Distribución Exponencial', labels, data, 'Tiempo entre Eventos', 'Densidad de Probabilidad');
        }

        async function playExponentialMelody() {
            stopPreviousMelody();
            const statusElement = document.getElementById('statusExponential');
            const abcDisplayElement = document.getElementById('abcDisplayExponential');
            const lambda = parseFloat(document.getElementById('expoLambda').value);
            const fixedNote = parseInt(document.getElementById('expoNote').value);
            const numDurations = parseInt(document.getElementById('expoNumDurations').value);

            if (Tone.context.state !== 'running') {
                statusElement.textContent = 'Por favor, habilita el audio primero.';
                return;
            }

            statusElement.textContent = 'Generando melodía...';
            abcDisplayElement.innerHTML = ''; // Clear previous score

            const melody = [];
            let totalDuration = 0;
            for (let i = 0; i < numDurations; i++) {
                // Generate duration from exponential distribution
                let duration = -Math.log(1 - Math.random()) / lambda;
                // Map duration to a musical note/rest and its length
                // This is a simplified mapping; you might want to quantize to musical durations
                melody.push({ note: fixedNote, duration: duration });
                totalDuration += duration;
            }

            const now = Tone.now();
            let startTime = now;

            const abcNotes = melody.map(event => {
                if (event.note === null) {
                    // Simplified: map duration to rest length (e.g., 1 for eighth, 2 for quarter)
                    let restLength = Math.max(1, Math.round(event.duration / L_DEFAULT_SECONDS));
                    return 'z' + restLength;
                }
                // Convert MIDI to note name (simplified)
                const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
                const octave = Math.floor(event.note / 12) - 1;
                const noteIndex = event.note % 12;
                let noteName = noteNames[noteIndex];

                // Convert note name to ABC notation (simplified)
                let abcNote = noteName.replace("#", "^"); // Handle sharps
                if (octave < 4) {
                    abcNote = abcNote.toLowerCase().repeat(4 - octave);
                } else if (octave > 4) {
                    abcNote = abcNote.toUpperCase() + "'".repeat(octave - 4);
                }
                 // Simplified: map duration to note length (e.g., 1 for eighth, 2 for quarter)
                let noteLength = Math.max(1, Math.round(event.duration / L_DEFAULT_SECONDS));
                return abcNote + noteLength;
            }).join(' ');


            melody.forEach((event) => {
                if (event.note !== null) {
                    const freq = Tone.Midi(event.note).toFrequency();
                    // Use the generated duration directly for playback
                    synth.triggerAttackRelease(freq, event.duration, startTime);
                }
                startTime += event.duration;
            });

            statusElement.textContent = 'Reproduciendo...';

            // Render ABC notation
            const abcString = `X:1\nT:Melodía Generada (Exponencial)\nM:4/4\nL:1/8\nK:C\n${abcNotes}|]`;
             ABCJS.renderAbc("abcDisplayExponential", abcString);


            // Update status after playback
            Tone.Transport.scheduleOnce(() => {
                statusElement.textContent = 'Melodía generada y reproducida.';
            }, startTime);
        }

        // Markov Chains (Order 1)
        function getMarkovTransitionMatrix() {
            const matrix = [];
            const states = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5']; // Corresponding notes
            const numStates = states.length;

            for (let i = 0; i < numStates; i++) {
                matrix[i] = [];
                let rowSum = 0;
                for (let j = 0; j < numStates; j++) {
                    const inputId = `m${i}${j}`;
                    const value = parseFloat(document.getElementById(inputId).value);
                    matrix[i][j] = value;
                    rowSum += value;
                }
                 // Normalize row to ensure probabilities sum to 1
                if (rowSum > 0) {
                    for (let j = 0; j < numStates; j++) {
                        matrix[i][j] /= rowSum;
                    }
                } else {
                     // If row sum is 0, make transitions equally likely
                    for (let j = 0; j < numStates; j++) {
                        matrix[i][j] = 1 / numStates;
                    }
                }
            }
            return matrix;
        }

        function updateMarkovChart() {
            const matrix = getMarkovTransitionMatrix();
            const states = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5']; // Corresponding notes

            // For simplicity, let's visualize the transition probabilities from the first state (C4)
            const labels = states;
            const data = matrix[0]; // Probabilities from C4 to other states

            renderChart('markovChart', 'Probabilidades de Transición desde C4 (Markov Orden 1)', labels, data, 'Siguiente Nota', 'Probabilidad');
        }

        async function playMarkovMelody() {
            stopPreviousMelody();
            const statusElement = document.getElementById('statusMarkov');
            const abcDisplayElement = document.getElementById('abcDisplayMarkov');
            const matrix = getMarkovTransitionMatrix();
            const states = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5']; // Corresponding notes
            const melodyLength = parseInt(document.getElementById('markovLength').value);

            if (Tone.context.state !== 'running') {
                statusElement.textContent = 'Por favor, habilita el audio primero.';
                return;
            }

            statusElement.textContent = 'Generando melodía...';
            abcDisplayElement.innerHTML = ''; // Clear previous score

            const melody = [];
            // Start with a random initial state
            let currentStateIndex = Math.floor(Math.random() * states.length);
            melody.push(states[currentStateIndex]);

            for (let i = 1; i < melodyLength; i++) {
                const transitionProbabilities = matrix[currentStateIndex];
                let cumulativeProbability = 0;
                const randomValue = Math.random();
                let nextStateIndex = 0;

                for (let j = 0; j < states.length; j++) {
                    cumulativeProbability += transitionProbabilities[j];
                    if (randomValue <= cumulativeProbability) {
                        nextStateIndex = j;
                        break;
                    }
                }
                currentStateIndex = nextStateIndex;
                melody.push(states[currentStateIndex]);
            }

            const now = Tone.now();
            let startTime = now;

            const abcNotes = melody.map(note => {
                // Convert note name (e.g., 'C4') to ABC notation (e.g., C)
                // This is a simplified conversion and might need adjustment for octaves
                const noteName = note.charAt(0);
                const octave = parseInt(note.charAt(1));
                let abcNote = noteName;
                if (octave < 4) {
                    abcNote = abcNote.toLowerCase().repeat(4 - octave);
                } else if (octave > 4) {
                    abcNote = abcNote.toUpperCase() + "'".repeat(octave - 4);
                }
                 // Add duration (e.g., 4 for quarter note) - assuming quarter notes for simplicity
                return abcNote + '4';
            }).join(' ');


            melody.forEach((note) => {
                // Convert note name (e.g., 'C4') to frequency or MIDI
                // Tone.js can handle note names directly
                synth.triggerAttackRelease(note, baseDuration, startTime);
                startTime += Tone.Time(baseDuration).toSeconds();
            });

            statusElement.textContent = 'Reproduciendo...';

            // Render ABC notation
            const abcString = `X:1\nT:Melodía Generada (Markov Orden 1)\nM:4/4\nL:1/8\nK:C\n${abcNotes}|]`;
             ABCJS.renderAbc("abcDisplayMarkov", abcString);


            // Update status after playback
            Tone.Transport.scheduleOnce(() => {
                statusElement.textContent = 'Melodía generada y reproducida.';
            }, startTime);
        }
    </script>
</body>

</html>